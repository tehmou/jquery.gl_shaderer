<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <link rel="stylesheet" href="style.css">

    <script type="shader-vs" id="shader-vs">
        attribute vec3 position;
        varying vec2 picturePosition;

        void main(void) {
            picturePosition = position.st;
            gl_Position = vec4(position.x, position.y, 0.0, 1.0);
        }
    </script>
    
    <script type="shader-fs" id="shader-fs">
        #ifdef GL_ES
        precision highp float;
        #endif

        uniform vec2 resolution;
        uniform sampler2D tex0;
        uniform sampler2D tex1;
        uniform sampler2D tex2;
        uniform float ratio;
        varying vec2 picturePosition;

        void addDistortion(vec2 delta, in vec2 pos, in sampler2D s, inout vec2 distort) {
            distort = distort + delta*texture2D(s, pos+delta).x;
        }

        void main(void) {
            vec2 p = picturePosition.xy;
            vec2 texCoord = vec2(p.s*.5+.5,.5-p.t*.5);
            vec4 o0 = texture2D(tex0,texCoord);
            vec4 o1 = texture2D(tex1,texCoord);
            vec4 o2 = texture2D(tex2,texCoord);

            float burnRatio = (o2.x-ratio/.75)+.3;

            float alpha = clamp(burnRatio/.03, 0.0, 1.0);

            float overlayColorMagnitude = 1.0-clamp(burnRatio/0.3, 0.0, 1.0);
            vec3 overlayColor = vec3(-.3*overlayColorMagnitude,-.7*overlayColorMagnitude,-1.0);
            vec3 colorAdjust = overlayColorMagnitude*overlayColor;


            vec2 distort = vec2(0.0);
            float nx = (1.0-burnRatio)*30.0/resolution.x;
            float ny = (1.0-burnRatio)*30.0/resolution.y;

            addDistortion(vec2(-nx, -ny), texCoord, tex2, distort);
            addDistortion(vec2(0.0, -ny), texCoord, tex2, distort);
            addDistortion(vec2(nx, -ny), texCoord, tex2, distort);
            addDistortion(vec2(nx, 0.0), texCoord, tex2, distort);
            addDistortion(vec2(nx, ny), texCoord, tex2, distort);
            addDistortion(vec2(0.0, ny), texCoord, tex2, distort);
            addDistortion(vec2(-nx, ny), texCoord, tex2, distort);
            addDistortion(vec2(-nx, 0.0), texCoord, tex2, distort);

            vec4 base = vec4(texture2D(tex0, texCoord+distort*burnRatio).xyz, 1.0);//(alpha>0.0?1.0:0.0));
            gl_FragColor = vec4(base.xyz+colorAdjust+(1.0-alpha), alpha);
        }
    </script>

    <script type="text/javascript" src="lib/jquery-1.6.1.js"></script>
    <script type="text/javascript" src="jquery.webglsurface.js"></script>

    <script type="text/javascript">

        $(function () {
            var rendererSettings = {
                textureUrls: ["images/IMG_2273.JPG", "images/IMG_2235.JPG", "images/burn3.png"],
                fragmentShaders: [$("#shader-fs").html()],
                vertexShaders: [$("#shader-vs").html()],
                uniforms: { ratio: { type: "1f", value: 0.0 } }
            };

            function updateSize() {
                var el = $("#content"),
                    bodyHeight = el.height(),
                    screenHeight = $("body").height(),
                    r, item;

                el.html("");
                for (var i = 0; i < bodyHeight; i += 20) {
                    if (r === 1.0) {
                        break;
                    }
                    r = Math.min(1.0, Math.max(0.0, (i - screenHeight/2)/(bodyHeight - screenHeight -20)));
                    item = $("<span>" + Math.floor(100*r) + "</span>")
                    el.append(item);
                    item.css("opacity", r);
                }
            }

            function updateScroll(event) {
                rendererSettings.uniforms.ratio.value = document.body.scrollTop/($("#content").height()-document.body.clientHeight);
                rendererSettings.render();
            }

            $("#webgl-canvas").webglsurface(rendererSettings);

            $(window).resize(updateSize);
            $(window).scroll(updateScroll);

            updateSize();
            updateScroll();
        });

    </script>

    <body>
        <canvas id="webgl-canvas"></canvas>
        <div id="content"></div>
        <div id="pointer"><span>&lt;=</span></div>
    </body>
</html>