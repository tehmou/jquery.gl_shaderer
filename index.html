<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <style type="text/css">

        body {
            position: absolute;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            font-family: "Droid Sans", "Arial", sans;
        }

        #content {
            position: absolute;
            width: 100px;
            height: 400%;
            text-align: right;
        }

        #content span {
            display: block;
            height: 20px;
            margin-right: 40px;
        }

        #pointer {
            position: fixed;
            top: 50%;
            left: 70px;
            margin-top: -7px;
        }

        #webgl-canvas {
            position: fixed;
            width: 720px;
            height: 480px;
            left: 50%;
            top: 50%;
            margin-left: -360px;
            margin-top: -240px;
        }

    </style>

    <script type="shader-vs" id="shader-vs">
        attribute vec3 position;
        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;
        varying vec2 picturePosition;

        void main(void) {
            picturePosition = position.st;
            gl_Position = uPMatrix*uMVMatrix*vec4(position.x, position.y, 0.0, 1.0);
        }
    </script>
    
    <script type="shader-fs" id="shader-fs">
        #ifdef GL_ES
        precision highp float;
        #endif

        uniform vec2 resolution;
        uniform sampler2D tex0;
        uniform sampler2D tex1;
        uniform sampler2D tex2;
        uniform float ratio;
        varying vec2 picturePosition;

        void addDistortion(vec2 delta, in vec2 pos, in sampler2D s, inout vec2 distort) {
            distort = distort + delta*texture2D(s, pos+delta).x;
        }

        void main(void) {
            vec2 p = picturePosition.xy;
            vec2 texCoord = vec2(p.s*.5+.5,.5-p.t*.5);
            vec4 o0 = texture2D(tex0,texCoord);
            vec4 o1 = texture2D(tex1,texCoord);
            vec4 o2 = texture2D(tex2,texCoord);

            float burnRatio = (o2.x-ratio/.75)+.3;

            float alpha = clamp(burnRatio/.03, 0.0, 1.0);

            float overlayColorMagnitude = 1.0-clamp(burnRatio/0.3, 0.0, 1.0);
            vec3 overlayColor = vec3(-.3*overlayColorMagnitude,-.7*overlayColorMagnitude,-1.0);
            vec3 colorAdjust = overlayColorMagnitude*overlayColor;


            vec2 distort = vec2(0.0);
            float nx = (1.0-burnRatio)*30.0/resolution.x;
            float ny = (1.0-burnRatio)*30.0/resolution.y;

            addDistortion(vec2(-nx, -ny), texCoord, tex2, distort);
            addDistortion(vec2(0.0, -ny), texCoord, tex2, distort);
            addDistortion(vec2(nx, -ny), texCoord, tex2, distort);
            addDistortion(vec2(nx, 0.0), texCoord, tex2, distort);
            addDistortion(vec2(nx, ny), texCoord, tex2, distort);
            addDistortion(vec2(0.0, ny), texCoord, tex2, distort);
            addDistortion(vec2(-nx, ny), texCoord, tex2, distort);
            addDistortion(vec2(-nx, 0.0), texCoord, tex2, distort);

            vec4 base = vec4(texture2D(tex0, texCoord+distort*burnRatio).xyz, 1.0);//(alpha>0.0?1.0:0.0));
            gl_FragColor = vec4(base.xyz+colorAdjust+(1.0-alpha), alpha);
        }
    </script>

    <script type="text/javascript" src="lib/jquery-1.6.1.js"></script>
    <script type="text/javascript" src="lib/RequestAnimationFrame.js"></script>
    <script type="text/javascript" src="lib/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="glShaderUtils.js"></script>
    <script type="text/javascript" src="glTextureUtils.js"></script>

    <script type="text/javascript">

    $(function () {

        var renderer = ({
            el: $("#webgl-canvas"),
            image2Url: "images/IMG_2235.JPG",
            image1Url: "images/IMG_2273.JPG",
            image3Url: "images/burn3.png",
            fragmentShaders: [$("#shader-fs").html()],
            vertexShaders: [$("#shader-vs").html()],
            shader: null,

            init: function () {
                var that = this,
                    thatRenderLoop = this.renderLoop,
                    thatUpdateDimensions = this.updateDimensions;

                this.renderLoop = function () { thatRenderLoop.apply(that, arguments) };
                this.el.resize(function () { thatUpdateDimensions.apply(that, arguments); });

                this.updateDimensions();
                this.createGL();
                this.createProgram();
                this.createPlane();
                this.createTextures();
                this.renderLoop();
            },
            updateDimensions: function () {
                this.el[0].width = this.el.width();
                this.el[0].height = this.el.height();
                this.viewportWidth = this.el[0].width;
                this.viewportHeight = this.el[0].height;
                this.halfW = this.viewportWidth/2.0;
                this.halfH = this.viewportHeight/2.0;
            },
            createGL: function () {
                this.gl = this.el[0].getContext("experimental-webgl");
                this.gl.enable(this.gl.TEXTURE_2D);
                this.gl.clearColor(0.0, 0.0, 0.0, 0.0);
            },
            createProgram: function () {
                this.shader = glShaderUtils.createShader(this.gl, this.fragmentShaders[0], this.vertexShaders[0]);
                this.gl.useProgram(this.shader);
                this.gl.enableVertexAttribArray(this.gl.getAttribLocation(this.shader, "position"));
               this.resetShaderMatrices();
            },
            resetShaderMatrices: function () {
                var m = mat4.create();
                mat4.identity(m);
                this.setShaderMVMatrix(m);
                this.setShaderPMatrix(m);
            },
            setShaderMVMatrix: function (matrix) {
                this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.shader, "uMVMatrix"), false, matrix);
            },
            setShaderPMatrix: function (matrix) {
                this.gl.uniformMatrix4fv(this.gl.getUniformLocation(this.shader, "uPMatrix"), false, matrix);
            },
            createPlane: function () {
                var vertices = new Float32Array([ -1.0,-1.0, 1.0,-1.0, -1.0,1.0, 1.0,-1.0, 1.0,1.0, -1.0,1.0]);
                this.mQuadVBO = this.gl.createBuffer();
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.mQuadVBO);
                this.gl.bufferData(this.gl.ARRAY_BUFFER, vertices, this.gl.STATIC_DRAW);
            },
            createTextures: function () {
                this.texture1 = glTextureUtils.loadImageTexture(this.gl, this.image1Url);
                this.texture2 = glTextureUtils.loadImageTexture(this.gl, this.image2Url);
                this.texture3 = glTextureUtils.loadImageTexture(this.gl, this.image3Url);
            },
            renderLoop: function () {
                requestAnimationFrame(this.renderLoop);
                this.preRender();
                this.actualRender();
            },
            preRender: function () {
                this.gl.bindBuffer(this.gl.ARRAY_BUFFER, this.mQuadVBO);
                this.gl.vertexAttribPointer(this.gl.getAttribLocation(this.shader, "position"), 2, this.gl.FLOAT, false, 0, 0);
            },
            actualRender: function () {
                var w = this.viewportWidth;
                var h = this.viewportHeight;
                this.gl.viewport(0, 0, w, h);
                this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);

                if (!this.shader || !this.texture1 || !this.texture2) {
                    return;
                }

                this.gl.useProgram(this.shader);
                this.gl.enableVertexAttribArray(this.gl.getAttribLocation(this.shader, "position"));

                this.gl.uniform2f(this.gl.getUniformLocation(this.shader, "resolution"), w, h);
                this.gl.uniform1f(this.gl.getUniformLocation(this.shader, "ratio"), this.ratio);

                this.gl.activeTexture(this.gl.TEXTURE0);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture1);
                this.gl.uniform1i(this.gl.getUniformLocation(this.shader, "tex0"), 0);

                this.gl.activeTexture(this.gl.TEXTURE1);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture2);
                this.gl.uniform1i(this.gl.getUniformLocation(this.shader, "tex1"), 1);

                this.gl.activeTexture(this.gl.TEXTURE2);
                this.gl.bindTexture(this.gl.TEXTURE_2D, this.texture3);
                this.gl.uniform1i(this.gl.getUniformLocation(this.shader, "tex2"), 2);

                this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            }
        });


        function updateSize() {
            var el = $("#content"),
                bodyHeight = el.height(),
                screenHeight = $("body").height(),
                r, item;

            el.html("");
            for (var i = 0; i < bodyHeight; i += 20) {
                if (r === 1.0) {
                    break;
                }
                r = Math.min(1.0, Math.max(0.0, (i - screenHeight/2)/(bodyHeight - screenHeight -20)));
                item = $("<span>" + Math.floor(100*r) + "</span>")
                el.append(item);
                item.css("opacity", r);
            }
        }

        function updateScroll(event) {
            renderer.ratio = document.body.scrollTop/($("#content").height()-document.body.clientHeight);
        }

        $(window).resize(updateSize);
        $(window).scroll(updateScroll);

        updateSize();
        updateScroll();
        renderer.init();

    });

    </script>

    <body>
        <canvas id="webgl-canvas"></canvas>
        <div id="content"></div>
        <div id="pointer"><span>&lt;=</span></div>
    </body>
</html>